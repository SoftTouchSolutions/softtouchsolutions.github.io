import{r as g,j as e}from"./mui-CVeSmhdP.js";import{a8 as W,f as X,R as _,C as i,g as U,n as R,h as q,I as d,L as o,A as x,S as p}from"./index-Cjmwo3Rz.js";import{C as A}from"./CardFooter-BZlwK9ez.js";import{C as N}from"./CardTitle-_F_6FAAC.js";import{S as I}from"./react-select.esm-QKf6Joix.js";import{u as Y}from"./16-Baksg-pw.js";import"./vendor-CC_ZIGTP.js";import"./utils-ngrFHoWO.js";const ie=()=>{const[C,E]=g.useState([]),[ee,D]=g.useState([]),[$,b]=g.useState([]),[F,y]=g.useState(!1),[B,M]=g.useState(Y),{employeeId:v}=W(),[t,f]=g.useState({loading:!1,title:"",staff_name:"",email:"",userId:"",employeeID:"",phonenumber:"",address:"",deptcode:"",deptname:"",managerId:"",managername:"",job_role:"",contract_type:"",employment_date:"",branch:"",training:"",certification:"",skills:"",interests:"",status:"active"}),[c,k]=g.useState({current_password:"",new_password:"",confirm_password:""}),[m,H]=g.useState({hasMinLength:!1,hasUppercase:!1,hasLowercase:!1,hasNumber:!1,hasSpecialChar:!1,passwordsMatch:!1}),[J,O]=g.useState(!1);g.useEffect(()=>{(async()=>{try{y(!0);const a=JSON.parse(localStorage.getItem("user_info")||sessionStorage.getItem("user_info")||"{}").userType||"employee",l=[V()];a==="manager"&&l.push(G()),await Promise.all(l)}catch(s){console.error("Error fetching initial data:",s)}finally{y(!1)}})()},[]),g.useEffect(()=>{(async()=>{try{if(y(!0),v){console.log(`Fetching specific employee data for ID: ${v}`);const s=await x.getEmployee(v);s&&f(a=>{var l,h,n;return{...a,...s,deptname:((l=s.department)==null?void 0:l.deptname)||"",deptcode:((h=s.department)==null?void 0:h.deptcode)||"",managername:((n=s.manager)==null?void 0:n.staff_name)||""}})}else{console.log("No employeeId provided, fetching current user profile");const s=await x.getUserProfile();s&&(console.log("Setting form data with profile data:",s),f(a=>({...a,...s})))}}catch(s){console.error("Failed to fetch profile data:",s),p.fire({icon:"error",title:"Error",text:"Failed to load profile data. Please try again later."})}finally{y(!1)}})()},[v]);const V=async()=>{try{const r=await x.getAllDepartments();r&&r.length>0?E(r.map(s=>({value:s.deptcode,label:s.deptname,data:s}))):(console.log("No departments found"),E([]))}catch(r){console.error("Error fetching departments:",r),p.fire({icon:"error",title:"Error",text:"Failed to fetch departments. Please try again later."})}},G=async()=>{var r;try{const s=await x.getallmanagers();s&&s.length>0?(console.log("Fetched managers:",s),D(s.map(a=>({value:a._id,label:a.staff_name,data:a})))):(console.log("No managers found - this may be due to insufficient role permissions"),D([]),(JSON.parse(localStorage.getItem("user_info")||sessionStorage.getItem("user_info")||"{}").role||"employee")==="employee"&&(console.log("Employee role detected - manager access not available"),(r=toast==null?void 0:toast.info)==null||r.call(toast,"Manager selection not available with your current role permissions.",{position:"top-right",autoClose:5e3,hideProgressBar:!1,closeOnClick:!0,pauseOnHover:!0,draggable:!0})))}catch(s){console.error("Error fetching managers:",s),(!s.response||s.response.status!==403)&&p.fire({icon:"error",title:"Error",text:"Failed to fetch managers. Please try again later."})}},T=async r=>{if(!r){b([]);return}try{y(!0);const s=await x.getManagersByDepartment(r);if(s&&s.length>0){const a=s.map(l=>({value:l._id,label:l.staff_name,data:l}));b(a),console.log(`Filtered managers for ${r}:`,a)}else b([]),console.log(`No managers found for department ${r}`)}catch(s){b([]),console.error(`Error fetching managers for ${r}:`,s),p.fire({icon:"error",title:"Error",text:`Could not fetch managers for ${r}. Please try again later.`})}finally{y(!1)}};g.useEffect(()=>{t.deptname?(console.log(`Department changed to: ${t.deptname}`),T(t.deptname)):b([])},[t.deptname]),g.useEffect(()=>{(async()=>{try{f(a=>({...a,loading:!0}));const s=await x.getCurrentUser();if(console.log("User data response:",s),s&&s.data){if(s.data.profile_picture){console.log("Profile picture found:",s.data.profile_picture);const n=new Date().getTime();M(`http://localhost:8000${s.data.profile_picture}?t=${n}`)}const a=s.data,l=(a==null?void 0:a.job_role)||(a==null?void 0:a.jobRole)||(a==null?void 0:a.jobrole)||"",h=(a==null?void 0:a.contract_type)||(a==null?void 0:a.contractType)||(a==null?void 0:a.contracttype)||"";f(n=>{const j={...n,loading:!1,staff_name:a.staff_name||a.email||"",email:a.email||"",userId:a.id||a._id||"",employeeID:a.id||a._id||"",userType:a.userType||"",job_role:l,contract_type:h,deptname:a.deptname||"",deptcode:a.deptcode||"",managerId:a.managerId||"",managername:a.managername||""};return console.log("Updated form data:",j),j})}}catch(s){console.error("Error loading user data:",s),f(a=>({...a,loading:!1})),p.fire("Error","Failed to load user data. Please try again later.","error")}})()},[]);const u=async r=>{const{name:s,value:a}=r.target;if(f({...t,[s]:a}),s==="deptcode"&&a)try{const l=C.find(h=>h.value===a);if(l&&l.label){const h=l.label;console.log(`Found department name "${h}" for code ${a}, fetching manager`);const n=await x.getManagerByDepartment(h);n&&n.staff_name?f(j=>({...j,managername:n.staff_name,managerId:n._id||""})):(console.log(`No manager found for department "${h}"`),f(j=>({...j,managername:"",managerId:""})))}}catch(l){console.error("Error fetching manager:",l)}},P=(r,s)=>{if(!r&&s==="deptname")f({...t,[s]:"",deptcode:"",managerId:"",managername:""}),b([]);else if(r&&s==="deptname"){const a=r.label,l=r.value;f({...t,[s]:a,deptcode:l,managerId:"",managername:""}),T(a)}else f(r&&s==="managerId"?{...t,managerId:r.value,managername:r.label}:!r&&s==="managerId"?{...t,managerId:"",managername:""}:{...t,[s]:r?r.value:""})},z=async r=>{var l,h;r.preventDefault();const a=["staff_name","job_role","contract_type"].filter(n=>!t[n]);if(a.length>0){p.fire("Error",`Please fill in the following required fields: ${a.join(", ")}`,"error");return}try{const n={...t,employeeID:t.employeeID||t.userId,managerId:t.managerId||"",managername:t.managername||"",employment_date:t.employment_date?new Date(t.employment_date).toISOString():null};console.log("Sending profile update data:",n);const j=await x.updateUserProfile(n);p.fire("Success","Profile updated successfully","success")}catch(n){console.error("Error updating profile:",n);const j=((h=(l=n.response)==null?void 0:l.data)==null?void 0:h.detail)||"Failed to update profile";p.fire({icon:"error",title:"Error",text:j})}},Z=async r=>{const s=r.target.files[0];if(s)try{const a=await x.uploadProfilePicture(s);if(a.path){const l=new Date().getTime();M(`http://localhost:8000${a.path}?t=${l}`)}p.fire("Success","Profile picture updated successfully","success")}catch(a){console.error("Error uploading profile picture:",a),p.fire("Error","Failed to upload profile picture","error")}},S=r=>{const{name:s,value:a}=r.target,l={...c,[s]:a};k(l),(s==="new_password"||s==="confirm_password")&&K(l.new_password,l.confirm_password)},K=(r,s)=>{H({hasMinLength:r.length>=8,hasUppercase:/[A-Z]/.test(r),hasLowercase:/[a-z]/.test(r),hasNumber:/\d/.test(r),hasSpecialChar:/[!@#$%^&*(),.?":{}|<>]/.test(r),passwordsMatch:r===s&&r.length>0})},w=()=>Object.values(m).every(Boolean),Q=async r=>{var s,a;if(r.preventDefault(),!c.current_password||!c.new_password||!c.confirm_password){p.fire("Error","All password fields are required.","error");return}if(!w()){p.fire("Error","Password does not meet the requirements.","error");return}try{await x.changePassword({current_password:c.current_password,new_password:c.new_password,confirm_password:c.confirm_password}),k({current_password:"",new_password:"",confirm_password:""}),p.fire("Success","Password changed successfully.","success")}catch(l){console.error("Error changing password:",l),p.fire("Error",((a=(s=l.response)==null?void 0:s.data)==null?void 0:a.detail)||"Failed to change password","error")}},L=[{value:"Male",label:"Male"},{value:"Female",label:"Female"}];return e.jsxs("div",{children:[e.jsx(X,{title:"Employee Profile",home:"Home",name:"Pages",fonticonsname:"EditProfile"}),e.jsxs(_,{children:[e.jsx(i,{xl:"4",lg:"5",children:e.jsxs(U,{children:[e.jsx(R,{children:e.jsx(N,{children:"Edit Password"})}),e.jsxs(q,{children:[e.jsxs("div",{className:"text-center mb-5",children:[e.jsx("img",{alt:"User Avatar",className:"rounded-circle me-3",src:B,style:{width:"150px",height:"150px",objectFit:"cover"}}),e.jsxs("div",{className:"mt-4 ms-0 ms-sm-auto",children:[e.jsx(d,{type:"file",accept:"image/*",onChange:Z,style:{display:"none"},id:"profile-picture-input"}),e.jsx(o,{htmlFor:"profile-picture-input",className:"btn btn-primary mb-1 me-1",children:"Change Picture"})]})]}),e.jsxs("div",{className:"mb-3",children:[e.jsx(o,{className:"form-label",children:"Current Password"}),e.jsx(d,{type:"password",name:"current_password",value:c.current_password,onChange:S,className:"form-control"})]}),e.jsxs("div",{className:"mb-3",children:[e.jsx(o,{className:"form-label",children:"New Password"}),e.jsx(d,{type:"password",name:"new_password",value:c.new_password,onChange:S,onFocus:()=>O(!0),className:`form-control ${c.new_password&&!w()?"is-invalid":c.new_password&&w()?"is-valid":""}`}),J&&e.jsxs("div",{className:"password-requirements mt-2 p-3 border rounded bg-light",children:[e.jsx("small",{className:"text-muted d-block mb-2",children:e.jsx("strong",{children:"Password Requirements:"})}),e.jsxs("div",{className:"row",children:[e.jsxs("div",{className:"col-md-6",children:[e.jsxs("small",{className:`d-block ${m.hasMinLength?"text-success":"text-danger"}`,children:[e.jsx("i",{className:`fas ${m.hasMinLength?"fa-check":"fa-times"} me-1`}),"At least 8 characters"]}),e.jsxs("small",{className:`d-block ${m.hasUppercase?"text-success":"text-danger"}`,children:[e.jsx("i",{className:`fas ${m.hasUppercase?"fa-check":"fa-times"} me-1`}),"One uppercase letter"]}),e.jsxs("small",{className:`d-block ${m.hasLowercase?"text-success":"text-danger"}`,children:[e.jsx("i",{className:`fas ${m.hasLowercase?"fa-check":"fa-times"} me-1`}),"One lowercase letter"]})]}),e.jsxs("div",{className:"col-md-6",children:[e.jsxs("small",{className:`d-block ${m.hasNumber?"text-success":"text-danger"}`,children:[e.jsx("i",{className:`fas ${m.hasNumber?"fa-check":"fa-times"} me-1`}),"One number"]}),e.jsxs("small",{className:`d-block ${m.hasSpecialChar?"text-success":"text-danger"}`,children:[e.jsx("i",{className:`fas ${m.hasSpecialChar?"fa-check":"fa-times"} me-1`}),"One special character"]})]})]})]})]}),e.jsxs("div",{className:"mb-3",children:[e.jsx(o,{className:"form-label",children:"Confirm Password"}),e.jsx(d,{type:"password",name:"confirm_password",value:c.confirm_password,onChange:S,className:`form-control ${c.confirm_password&&!m.passwordsMatch?"is-invalid":c.confirm_password&&m.passwordsMatch?"is-valid":""}`}),c.confirm_password&&!m.passwordsMatch&&e.jsx("div",{className:"invalid-feedback",children:"Passwords do not match"}),c.confirm_password&&m.passwordsMatch&&e.jsx("div",{className:"valid-feedback",children:"Passwords match"})]})]}),e.jsxs(A,{className:"text-end",children:[e.jsx("button",{onClick:Q,className:"btn btn-primary me-1",disabled:!w()||!c.current_password,children:"Update Password"}),!w()&&c.new_password&&e.jsx("small",{className:"text-muted d-block mt-1",children:"Please meet all password requirements"})]})]})}),e.jsx(i,{xl:"8",lg:"7",children:e.jsxs(U,{children:[e.jsx(R,{children:e.jsx(N,{children:"Edit Employee Profile"})}),e.jsxs(q,{children:[e.jsx(N,{className:"font-weight-bold",children:"Basic Info:"}),e.jsxs(_,{children:[e.jsx(i,{sm:"6",md:"4",children:e.jsxs("div",{className:"mb-3",children:[e.jsx(o,{className:"form-label",children:"Title"}),e.jsx(d,{type:"text",name:"title",value:t.title||"",onChange:u,className:"form-control",placeholder:"Title"})]})}),e.jsx(i,{sm:"6",md:"8",children:e.jsxs("div",{className:"mb-3",children:[e.jsxs(o,{className:"form-label",children:["Full Name",e.jsx("span",{className:"text-danger",children:"*"})]}),e.jsx(d,{type:"text",name:"staff_name",value:t.staff_name||"",onChange:u,className:"form-control",placeholder:"Full Name",required:!0})]})}),e.jsx(i,{sm:"6",md:"4",children:e.jsxs("div",{className:"mb-3",children:[e.jsx(o,{className:"form-label",children:"Gender"}),e.jsx(I,{options:L,value:L.find(r=>r.value===t.gender),onChange:r=>P(r,"gender"),placeholder:"Select Gender",classNamePrefix:"select",isClearable:!0})]})}),e.jsx(i,{sm:"6",md:"4",children:e.jsxs("div",{className:"mb-3",children:[e.jsx(o,{className:"form-label",children:"Phone Number"}),e.jsx(d,{type:"text",name:"phonenumber",value:t.phonenumber||"",onChange:u,className:"form-control",placeholder:"Phone Number"})]})}),e.jsx(i,{sm:"6",md:"4",children:e.jsxs("div",{className:"mb-3",children:[e.jsx(o,{className:"form-label",children:"Address"}),e.jsx(d,{type:"text",name:"address",value:t.address||"",onChange:u,className:"form-control",placeholder:"Address"})]})}),e.jsx(i,{sm:"6",md:"4",children:e.jsxs("div",{className:"mb-3",children:[e.jsx(o,{className:"form-label",children:"Ethnicity"}),e.jsx(d,{type:"text",name:"ethnicity",value:t.ethnicity||"",onChange:u,className:"form-control",placeholder:"Ethnicity"})]})})]}),e.jsx(N,{className:"font-weight-bold mt-5",children:"Job Details:"}),e.jsxs(_,{children:[e.jsx(i,{sm:"6",md:"6",children:e.jsxs("div",{className:"mb-3",children:[e.jsxs(o,{className:"form-label",children:["Department",e.jsx("span",{className:"text-danger",children:"*"})]}),e.jsx(I,{name:"deptname",value:C.find(r=>r.label===t.deptname)||null,onChange:r=>P(r,"deptname"),options:C,placeholder:"Select Department",isClearable:!0,isLoading:F,classNamePrefix:"select"})]})}),e.jsx(i,{sm:"6",md:"6",children:e.jsxs("div",{className:"mb-3",children:[e.jsx(o,{className:"form-label",children:"Manager"}),e.jsx(I,{name:"managerId",value:$.find(r=>r.value===t.managerId)||null,onChange:r=>P(r,"managerId"),options:$,placeholder:t.deptname?"Select Manager":"Select Department First",isClearable:!0,isLoading:F,classNamePrefix:"select"},`manager-${t.deptname||"none"}`)]})}),e.jsx(i,{sm:"6",md:"6",children:e.jsxs("div",{className:"mb-3",children:[e.jsxs(o,{className:"form-label",children:["Job Role",e.jsx("span",{className:"text-danger",children:"*"})]}),e.jsx(d,{type:"text",name:"job_role",value:t.job_role||"",onChange:u,className:"form-control",placeholder:"Job Role"})]})}),e.jsx(i,{sm:"6",md:"6",children:e.jsxs("div",{className:"mb-3",children:[e.jsxs(o,{className:"form-label",children:["Contract Type",e.jsx("span",{className:"text-danger",children:"*"})]}),e.jsx(d,{type:"text",name:"contract_type",value:t.contract_type||"",onChange:u,className:"form-control",placeholder:"Contract Type"})]})}),e.jsx(i,{sm:"6",md:"6",children:e.jsxs("div",{className:"mb-3",children:[e.jsx(o,{className:"form-label",children:"Employment Date"}),e.jsx(d,{type:"date",name:"employment_date",value:t.employment_date||"",onChange:u,className:"form-control"})]})})]}),e.jsx(N,{className:"font-weight-bold mt-5",children:"Other Details:"}),e.jsxs(_,{children:[e.jsx(i,{sm:"6",md:"6",children:e.jsxs("div",{className:"mb-3",children:[e.jsx(o,{className:"form-label",children:"Training"}),e.jsx(d,{type:"text",name:"training",value:t.training||"",onChange:u,className:"form-control",placeholder:"Training"})]})}),e.jsx(i,{sm:"6",md:"6",children:e.jsxs("div",{className:"mb-3",children:[e.jsx(o,{className:"form-label",children:"Certification"}),e.jsx(d,{type:"text",name:"certification",value:t.certification||"",onChange:u,className:"form-control",placeholder:"Certification"})]})}),e.jsx(i,{sm:"6",md:"6",children:e.jsxs("div",{className:"mb-3",children:[e.jsx(o,{className:"form-label",children:"Skills"}),e.jsx(d,{type:"text",name:"skills",value:t.skills||"",onChange:u,className:"form-control",placeholder:"Skills"})]})}),e.jsx(i,{sm:"6",md:"6",children:e.jsxs("div",{className:"mb-3",children:[e.jsx(o,{className:"form-label",children:"Interests"}),e.jsx(d,{type:"text",name:"interests",value:t.interests||"",onChange:u,className:"form-control",placeholder:"Interests"})]})})]})]}),e.jsx(A,{className:"text-end",children:e.jsx("div",{className:"btn-list",children:e.jsx("button",{onClick:z,className:"btn btn-primary",children:"Save Profile"})})})]})})]})]})};export{ie as default};
