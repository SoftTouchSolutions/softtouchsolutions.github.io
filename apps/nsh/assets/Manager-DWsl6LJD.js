import{r as n,j as e}from"./mui-CVeSmhdP.js";import{ab as oe,A as N,S,f as ie,R as de,C as ce,g as me,n as fe,aa as Y,I as m,B as j,h as pe,T as he,F as $,L as p,x as ue,y as F,z as P,p as ge,q as xe,r as je,v as C,s as ye}from"./index-BH8F5Bwl.js";import{C as _e}from"./CardTitle-DfjUI6oT.js";import"./vendor-CC_ZIGTP.js";import"./utils-ngrFHoWO.js";const we=()=>{const[q,G]=n.useState(!1),v=()=>G(!q),[L,i]=n.useState(!1),[E,V]=n.useState(""),[h,J]=n.useState({}),z=oe(),[Ne,ve]=n.useState([]),[U,De]=n.useState([]),[M,w]=n.useState([]),[B,y]=n.useState([]),[_,K]=n.useState(1),I=5,[r,x]=n.useState({staff_name:"",email:"",deptname:"",date_of_appointment:""}),[d,D]=n.useState({id:"",staff_name:"",email:"",department:"",date_of_appointment:"",employeeID:""}),[W,k]=n.useState(null),X=a=>{if(!a)return"N/A";try{return new Date(a).toLocaleDateString()}catch{return a}},Z=a=>{if(!a)return M;const t=a.toLowerCase();return M.filter(s=>s.staff_name&&s.staff_name.toLowerCase().includes(t)||s.email&&s.email.toLowerCase().includes(t)||s.department&&s.department.toLowerCase().includes(t))},T=n.useMemo(()=>Z(E),[M,E]),O=_*I,ee=O-I,H=T.slice(ee,O),R=Math.ceil(T.length/I),A=a=>K(a);n.useEffect(()=>{b(),ae()},[]);const ae=async()=>{i(!0);try{const a=await N.getManagerUsers();console.log("Fetched manager users:",a),a&&a.length>0?(y(a),console.log("Manager users set successfully:",a)):(y([]),console.log("No manager users found in the database"))}catch(a){console.error("Error fetching manager users:",a),y([]),S.fire({icon:"error",title:"Error",text:"Failed to fetch manager users from the server. Please try again later."})}finally{i(!1)}},b=async()=>{var u,g;i(!0);let a=!1;const t=localStorage.getItem("auth_token")||sessionStorage.getItem("auth_token")||localStorage.getItem("authToken")||sessionStorage.getItem("authToken");console.log("Auth token available:",t?"Yes":"No");let s=[];try{console.log("Attempting to fetch managers..."),console.log("Using auth token:",t?`${t.substring(0,10)}...`:"No token"),s=await N.getallmanagers(z),console.log("Successfully fetched managers:",s),Array.isArray(s)||(console.warn("API returned non-array managers data, converting to array:",s),s=s?[s]:[]);const c=s.map(o=>({id:o.id||o.sno||o._id||"",staff_name:o.staff_name||o.fullname||o.name||"Unknown",email:o.email||"",department:o.department||o.deptname||"",date_of_appointment:o.date_of_appointment||null,employeeID:o.employeeID||o.employee_id||""}));c&&c.length>0?(console.log("Normalized managers data:",c),w(c),console.log("All managers set with normalized data")):(w([]),console.warn("No managers returned - check authentication or data availability"),console.log("No managers found in the database"))}catch(c){a=!0,console.error("Error fetching managers:",c),console.error("Error details:",(u=c.response)==null?void 0:u.data),console.error("Error status:",(g=c.response)==null?void 0:g.status),w([])}let l=[];try{console.log("Attempting to fetch manager users..."),l=await N.getManagerUsers(z),console.log("Successfully fetched manager users:",l),l&&l.length>0?(y(l),console.log("All manager users set:",l)):(y([]),console.log("No manager users found in the database"))}catch(c){a=!0,console.error("Error fetching manager users:",c),y([])}a&&S.fire({icon:"error",title:"Error",text:"Failed to fetch managers or manager users from the server. Please try again later."}),i(!1)},f=(a,t)=>{const{name:s,value:l}=a.target;if(s==="employeeID"&&U.length>0){const u=U.find(g=>g.employeeID===l);t(u?g=>({...g,staff_name:u.staff_name||"",email:u.email||"",employeeID:l}):g=>({...g,employeeID:l}))}else t(u=>({...u,[s]:l}))},te=()=>{const a={};return r.staff_name||(a.staff_name="Full name is required"),r.email||(a.email="Email is required"),r.department||(a.department="Department is required"),r.date_of_appointment||(a.date_of_appointment="Date of appointment is required"),J(a),Object.keys(a).length===0},Q=async a=>{if(a.preventDefault(),!te()){S.fire({icon:"error",title:"Validation Error",text:"Please fill in all required fields"});return}i(!0);try{const t={staff_name:r.staff_name,email:r.email,department:r.department,date_of_appointment:r.date_of_appointment};console.log("Sending manager data:",t),await N.createManager(t),await b(),x({staff_name:"",email:"",department:"",date_of_appointment:""}),v()}catch(t){console.error("Error adding manager:",t)}finally{i(!1)}},se=(a,t)=>{a.preventDefault(),k(t.id),D({id:t.id,staff_name:t.staff_name,email:t.email,department:t.department,date_of_appointment:t.date_of_appointment,employeeID:t.employeeID})},ne=async a=>{a.preventDefault(),i(!0);try{const t={staff_name:d.staff_name,email:d.email,department:d.department,date_of_appointment:d.date_of_appointment};await N.updateManager(d.sno||d.id,t),await b(),k(null)}catch(t){console.error("Error updating manager:",t)}finally{i(!1)}},re=a=>{S.fire({title:"Are you sure?",text:`Do you want to delete manager "${a.staff_name}"?`,icon:"warning",showCancelButton:!0,confirmButtonColor:"#d33",cancelButtonColor:"#3085d6",confirmButtonText:"Yes, delete it!"}).then(async t=>{if(t.isConfirmed){i(!0);try{await N.deleteManager(a.sno),await b()}catch(s){console.error("Error deleting manager:",s)}finally{i(!1)}}})},le=()=>{k(null)};return e.jsxs("div",{children:[e.jsx(ie,{title:"",home:"Home",name:"Managers",fonticonsname:"Managers"}),e.jsx(de,{children:e.jsx(ce,{md:"12",xl:"12",children:e.jsxs(me,{children:[e.jsxs(fe,{className:"d-flex justify-content-between align-items-center",children:[e.jsx(_e,{tag:"h3",children:"Managers"}),e.jsxs("div",{className:"d-flex align-items-center",children:[L&&e.jsx(Y,{size:"sm",color:"primary",className:"me-2"}),e.jsx("div",{className:"input-group me-2",style:{width:"200px"},children:e.jsx(m,{type:"text",placeholder:"Search...",value:E,onChange:a=>V(a.target.value)})}),e.jsxs(j,{color:"primary",size:"sm",onClick:v,children:[e.jsx("i",{className:"fa fa-plus me-1"}),"New Manager"]})]})]}),e.jsxs(pe,{children:[e.jsx("div",{className:"table-responsive",children:e.jsxs(he,{className:"table-bordered",children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:"Full Name"}),e.jsx("th",{children:"Email"}),e.jsx("th",{children:"Department"}),e.jsx("th",{children:"Date of Appointment"}),e.jsx("th",{children:"Actions"})]})}),e.jsx("tbody",{children:H.length>0?e.jsx(e.Fragment,{children:H.map(a=>e.jsx(n.Fragment,{children:a.id===W?e.jsx("tr",{children:e.jsx("td",{colSpan:"6",children:e.jsx($,{onSubmit:ne,children:e.jsxs("div",{className:"d-flex flex-wrap align-items-end",children:[e.jsxs("div",{className:"me-2 mb-2",children:[e.jsx(p,{for:"editStaffName",children:"Full Name"}),e.jsx(m,{type:"text",name:"staff_name",id:"editStaffName",value:d.staff_name,onChange:t=>f(t,D),required:!0})]}),e.jsxs("div",{className:"me-2 mb-2",children:[e.jsx(p,{for:"editEmail",children:"Email"}),e.jsx(m,{type:"email",name:"email",id:"editEmail",value:d.email,onChange:t=>f(t,D),required:!0})]}),e.jsxs("div",{className:"me-2 mb-2",children:[e.jsx(p,{for:"editEmail",children:"Department"}),e.jsx(m,{type:"text",name:"department",id:"editDepartment",value:d.department,onChange:t=>f(t,D),required:!0})]}),e.jsxs("div",{className:"me-2 mb-2",children:[e.jsx(p,{for:"editDate",children:"Date of Appointment"}),e.jsx(m,{type:"date",name:"date_of_appointment",id:"editDate",value:d.date_of_appointment,onChange:t=>f(t,D),required:!0})]}),e.jsxs("div",{className:"mb-2",children:[e.jsx(j,{color:"success",type:"submit",className:"me-2",children:"Save"}),e.jsx(j,{type:"button",color:"secondary",onClick:le,children:"Cancel"})]})]})})})}):e.jsxs("tr",{children:[e.jsx("td",{children:a.staff_name}),e.jsx("td",{children:a.email}),e.jsx("td",{children:a.department}),e.jsx("td",{children:X(a.date_of_appointment)}),e.jsx("td",{children:e.jsxs("div",{className:"d-flex justify-content-center align-items-center",children:[e.jsx(j,{color:"primary",size:"sm",className:"btn-icon me-1",title:"Edit",style:{padding:"0.25rem 0.5rem"},onClick:t=>se(t,a),children:e.jsx("i",{className:"fa fa-edit"})}),e.jsx(j,{color:"danger",size:"sm",className:"btn-icon",title:"Delete",style:{padding:"0.25rem 0.5rem"},onClick:()=>re(a),children:e.jsx("i",{className:"fa fa-trash"})})]})})]})},a.id))}):e.jsx("tr",{children:e.jsx("td",{colSpan:"6",className:"text-center",children:L?e.jsx(Y,{size:"sm",color:"primary"}):"No managers found"})})})]})}),e.jsxs(ue,{className:"pagination justify-content-end mt-3",children:[e.jsx(F,{disabled:_===1,children:e.jsx(P,{onClick:()=>A(_-1),children:"Previous"})}),[...Array(R)].map((a,t)=>e.jsx(F,{active:_===t+1,children:e.jsx(P,{onClick:()=>A(t+1),children:t+1})},t)),e.jsx(F,{disabled:_===R,children:e.jsx(P,{onClick:()=>A(_+1),children:"Next"})})]})]})]})})}),e.jsxs(ge,{isOpen:q,toggle:v,children:[e.jsx(xe,{toggle:v,children:"Add New Manager"}),e.jsx(je,{children:e.jsxs($,{onSubmit:Q,children:[e.jsxs(C,{children:[e.jsx(p,{for:"employeeSelect",children:"Select Manager"}),e.jsxs(m,{type:"select",name:"employeeID",id:"employeeSelect",value:r.employeeID,onChange:a=>{if(f(a,x),a.target.value){const t=B.find(s=>s.email===a.target.value);if(t){const s=new Date().toISOString().split("T")[0];x(l=>({...l,staff_name:t.staff_name||"",email:t.email||"",department:t.department||"",deptcode:t.department||"",date_of_appointment:s,job_role:t.job_role||""}))}}},className:"mb-2",children:[e.jsx("option",{value:"",children:"-- Select Manager --"}),B.map(a=>e.jsx("option",{value:a.email,children:a.staff_name},a.email))]})]}),e.jsxs(C,{children:[e.jsx(p,{for:"staff_name",children:"Full Name"}),e.jsx(m,{type:"text",id:"staff_name",name:"staff_name",placeholder:"Full Name",value:r.staff_name,onChange:a=>f(a,x),required:!0,className:"mb-2"}),h.staff_name&&e.jsx("div",{className:"text-danger",children:h.staff_name})]}),e.jsxs(C,{children:[e.jsx(p,{for:"email",children:"Email"}),e.jsx(m,{type:"email",id:"email",name:"email",placeholder:"Email",value:r.email,onChange:a=>f(a,x),required:!0,className:"mb-2"}),h.email&&e.jsx("div",{className:"text-danger",children:h.email})]}),e.jsxs(C,{children:[e.jsx(p,{for:"department",children:"Department"}),e.jsx(m,{type:"text",id:"department",name:"department",placeholder:"Department",value:r.department,onChange:a=>f(a,x),className:"mb-2"}),h.department&&e.jsx("div",{className:"text-danger",children:h.department})]}),e.jsxs(C,{children:[e.jsx(p,{for:"dateAppointment",children:"Date of Appointment"}),e.jsx(m,{type:"date",id:"dateAppointment",name:"date_of_appointment",placeholder:"Date of Appointment",value:r.date_of_appointment,onChange:a=>f(a,x),required:!0,className:"mb-2"}),h.date_of_appointment&&e.jsx("div",{className:"text-danger",children:h.date_of_appointment})]})]})}),e.jsxs(ye,{children:[e.jsx(j,{color:"primary",onClick:Q,children:"Add Manager"}),e.jsx(j,{color:"secondary",onClick:v,children:"Close"})]})]})]})};export{we as default};
